<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>display graph</title>
    <style>

        #vis {
            height: 550px;
            width: 100%;
            background-color: #F8F9FB;
            border-bottom: 1px solid #e6e9ef;
        }

    </style>
</head>
<body>
<div id="vis">

</div>
<script src="../js/jquery-2.2.2.min.js" charset="utf-8"></script>
<script src="../js/d3.min.js" charset="utf-8"></script>
<script src="../js/vis.min.js"></script>
<script>
    var AUTHORIZATION = "Basic " + btoa("neo4j:password");

    function restPost(data) {
        var strData = JSON.stringify(data);
        return $.ajax({
            type: "POST",
            beforeSend: function (request) {
                if (AUTHORIZATION != undefined) {
                    request.setRequestHeader("Authorization", AUTHORIZATION);
                }
            },
            url: "http://localhost:7474/db/data/transaction/commit",
            contentType: "application/json",
            data: strData
        });
    }

    function parseGraphResultData(data) {
        var nodes = {}, edges = {};
        data.results[0].data.forEach(function (row) {
            row.graph.nodes.forEach(function (n) {
                if (!nodes.hasOwnProperty(n.id)) {
                    nodes[n.id] = n;
                }
            });

            row.graph.relationships.forEach(function (r) {
                if (!edges.hasOwnProperty(r.id)) {
                    edges[r.id] = r;
                }
            });
        });

        var nodesArray = [], edgesArray = [];

        for (var p in nodes) {
            if (nodes.hasOwnProperty(p)) {
                nodesArray.push(nodes[p]);
            }
        }

        for (var q in edges) {
            if (edges.hasOwnProperty(q)) {
                edgesArray.push(edges[q])
            }
        }

        return {nodes: nodesArray, edges: edgesArray};
    }

    function convertNodes(nodes) {
        var convertedNodes = [];

        nodes.forEach(function (node) {
            var nodeLabel = node.labels[0];
            convertedNodes.push({
                id: node.id,
                label: node.properties[Object.keys(node.properties)[0]],
                group: nodeLabel
            })
        });

        return convertedNodes;
    }

    function convertEdges(edges) {
        var convertedEdges = [];

        edges.forEach(function (edge) {
            convertedEdges.push({
                from: edge.startNode,
                to: edge.endNode,
                label: edge.type
            })
        });

        return convertedEdges;
    }

    function displayData(data) {
        var container = document.getElementById('vis');

        var options = {
            nodes: {
                shape: 'circle'
                //shape: 'dot',
                //borderWidth: 2,
                //size: 20,
                //font: {
                //    size: 10,
                //    color: '#ffffff'
                //}
            },
            edges: {
                //width: 2,
                //length: 200,
                //font: {
                //    align: 'top',
                //    size: 10
                //},
                arrows: 'to'
                //dashes:true
            },
            //groups: {
            //    "Person": {
            //        color: {background: '#68BDF6', border: '#5CA8DB'}
            //    },
            //    "Movie": {
            //        color: {background: '#FF756E', border: '#E06760'}
            //    }
            //}
        };

        // initialize the network!
        var network = new vis.Network(container, data, options);

        // To open Clusters on click
        network.on("selectNode", function(params) {
            if (params.nodes.length == 1) {
                if (network.isCluster(params.nodes[0]) == true) {
                    network.openCluster(params.nodes[0]);
                }
            }
        });

        network.cluster({
            joinCondition:function(childOptions) {
                return childOptions.group == "Agent";
            },
            clusterNodeProperties: {id:'agnt', shape:'database', label: "Agents"}
        });
        network.cluster({
            joinCondition:function(childOptions) {
                return childOptions.group == "Observation";
            },
            clusterNodeProperties: {id:'obs', shape:'database', label:"Observations"}
        });
        network.cluster({
            joinCondition:function(childOptions) {
                return childOptions.group == "HealthIssue";
            },
            clusterNodeProperties: {id:'hi', shape:'database', label:"HealthIssue"}
        });
        network.cluster({
            joinCondition:function(childOptions) {
                return childOptions.group == "Action";
            },
            clusterNodeProperties: {id:'act', shape:'database', label:"Actions"}
        });
    }


    restPost({
        "statements": [
            {
                //"statement": "match n,()-[r]-() return n,r",
                "statement": "match (a{name:\"John Smith\"})-[r*]-(n) return n,r",
                "resultDataContents": ["graph"]
            }
        ]
    }).done(function (data) {
        var graphData = parseGraphResultData(data);
        var nodes = convertNodes(graphData.nodes);
        var edges = convertEdges(graphData.edges);

        // provide the data in the vis format
        var visData = {
            nodes: nodes,
            edges: edges
        };

        displayData(visData);
    });

</script>
</body>
</html>