<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>display graph in a Neo4J database</title>
    <style>

        #vis {
            height: 550px;
            width: 100%;
            background-color: #F8F9FB;
            border-bottom: 1px solid #e6e9ef;
        }

    </style>
</head>
<body>
<p>
    This page is a simple example that can be used to display the content of a Neo4j database using <a
        href="http://visjs.org/">Vis.js</a> library.
    To be used you need to provide the conection details of a running Neo4j database.
</p>
<label>
    Protocol:<input id="protocolinput" type="text" value="http">
</label>
<label>
    Host:<input id="hostinput" type="text" value="localhost">
</label>
<label>
    Port:<input id="portinput" type="number" value="7474" min="0" max="65535">
</label>
<label>
    User:<input id="userinput" type="text" value="neo4j">
</label>
<label>
    password:<input id="passinput" type="password">
</label>
<button onclick="displayGraph()">Display Graph</button>
<div id="vis">

</div>
<script src="javascripts/jquery-2.2.2.min.js" charset="utf-8"></script>
<script src="javascripts/d3.min.js" charset="utf-8"></script>
<script src="javascripts/vis.min.js"></script>
<script>
    var AUTHORIZATION = "Basic " + btoa("neo4j:password");


    function restPost(data) {
        var strData = JSON.stringify(data);
        return $.ajax({
            type: "POST",
            beforeSend: function (request) {
                if (AUTHORIZATION != undefined) {
                    request.setRequestHeader("Authorization", AUTHORIZATION);
                }
            },
            url: $("#protocolinput").val() + "://" + $("#hostinput").val() + ":" + $("#portinput").val() + "/db/data/transaction/commit",
            contentType: "application/json",
            data: strData
        });
    }

    function parseGraphResultData(data) {
        var nodes = {}, edges = {};
        data.results[0].data.forEach(function (row) {
            row.graph.nodes.forEach(function (n) {
                if (!nodes.hasOwnProperty(n.id)) {
                    nodes[n.id] = n;
                }
            });

            row.graph.relationships.forEach(function (r) {
                if (!edges.hasOwnProperty(r.id)) {
                    edges[r.id] = r;
                }
            });
        });

        var nodesArray = [], edgesArray = [];

        for (var p in nodes) {
            if (nodes.hasOwnProperty(p)) {
                nodesArray.push(nodes[p]);
            }
        }

        for (var q in edges) {
            if (edges.hasOwnProperty(q)) {
                edgesArray.push(edges[q])
            }
        }

        return {nodes: nodesArray, edges: edgesArray};
    }

    function convertNodes(nodes) {
        var convertedNodes = [];

        nodes.forEach(function (node) {
            var nodeLabel = node.labels[0];
            convertedNodes.push({
                id: node.id,
                label: node.properties[Object.keys(node.properties)[0]],
                group: nodeLabel
            })
        });

        return convertedNodes;
    }

    function convertEdges(edges) {
        var convertedEdges = [];

        edges.forEach(function (edge) {
            convertedEdges.push({
                from: edge.startNode,
                to: edge.endNode,
                label: edge.type
            })
        });

        return convertedEdges;
    }

    function displayData(data) {
        var container = document.getElementById('vis');

        var options = {
            nodes: {
                shape: 'circle'
            },
            edges: {
                arrows: 'to'
            }
        };

        // initialize the network!
        var network = new vis.Network(container, data, options);
    }

    function displayGraph() {
        AUTHORIZATION = "Basic " + btoa($("#userinput").val() + ":" + $("#passinput").val());

        restPost({
            "statements": [
                {
                    "statement": "match n,()-[r]-() return n,r",
                    "resultDataContents": ["graph"]
                }
            ]
        }).done(function (data) {
            var graphData = parseGraphResultData(data);
            var nodes = convertNodes(graphData.nodes);
            var edges = convertEdges(graphData.edges);

            // provide the data in the vis format
            var visData = {
                nodes: nodes,
                edges: edges
            };

            displayData(visData);
        });
    }

</script>
</body>
</html>